var x=Object.defineProperty;var y=(d,e,t)=>e in d?x(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var m=(d,e,t)=>(y(d,typeof e!="symbol"?e+"":e,t),t);import{E as H}from"./entry.c4fe7854.js";import{D as _,N as w,a as S,b as I,B as Q}from"./axios.7bde71be.js";import{p as A,g as z}from"./str.08505d9c.js";const{namedNode:j}=_,b=j("http://www.w3.org/1999/02/22-rdf-syntax-ns#type"),v=j("http://www.w3.org/2000/01/rdf-schema#label");class U{constructor(){m(this,"store");m(this,"data");m(this,"parser");m(this,"prefixes");m(this,"headerLinks");this.store=new w,this.parser=new S,this.data=[],this.prefixes={},this.headerLinks=[]}async fetch(e,t){try{t={...t,headers:{Accept:"text/anot+turtle"}};const s=await I(e,t);if(s.status!=200)throw new Error(`Request failed with status ${s.status}`);this.headerLinks=A(s.headers.link),await this.load(await s.data)}catch(s){throw s instanceof Error?new Error(`Error: ${s.message}`):new Error("An unknown error occurred.")}}async load(e){await this.parser.parse(e,(t,s,r)=>{r&&(this.prefixes=r),s&&this.data.push(s)}),this.store=new w(this.data)}expandAll(e){return e.map(t=>this.expand(t))}expand(e){const t=e.split(":");return t.length>=2&&t[0]in this.prefixes?(t[0]=this.prefixes[t[0]].toString(),t[0]+t.slice(1).join(":")):e}firstQuad(e,t,s,r){const a=this.store.getQuads(e,t,s,r);return a&&a.length>0?a[0]:null}list(e=[],t=[]){let s="",r=[],a=0;const c=this.firstQuad(null,this.expand("prez:count"),null,null);if(c!==null){a=parseInt(c.object.value),s=c.subject.value;const l=b;r=this.store.getSubjects(l,s,null)}else throw new Error("prez:count predicate not found");const i=this.store.getQuads(s,v,null,null),o=this.compact(s),n={listHeaders:{},header:{label:i.length>0?i[0].object.value:o,iri:s,link:s},count:a,list:[],iri:o},g=this.expandAll(e),h=this.expandAll(t);for(const l in r){const f=r[l].value,u=this.getSubjectData(f,g,h);Object.keys(u).filter(p=>p!="_meta").forEach(p=>{p in n.listHeaders||(n.listHeaders[p]=this.getHeader(this.expand(p),u[p]))}),u._meta&&u._meta["prez:searchResultURI"]&&u._meta["prez:searchResultURI"].links&&(console.log(u._meta["prez:searchResultURI"]),u["prez:link"]=u._meta["prez:searchResultURI"].links.length==1?u._meta["prez:searchResultURI"].links[0]:u._meta["prez:searchResultURI"].links,"prez:link"in n.listHeaders||(n.listHeaders["prez:link"]=this.getHeader(this.expand("prez:link"),{}))),n.list.push(u)}return n}search(e=[],t=[]){const s=this.list(e,t);return s.listHeaders["prez:link"]=this.getHeader(this.expand("prez:link"),{}),s.list.forEach(r=>{r._meta["prez:searchResultURI"]&&r._meta["prez:searchResultURI"].links&&(console.log(r._meta["prez:searchResultURI"]),r["prez:link"]=r._meta["prez:searchResultURI"].links.length==1?r._meta["prez:searchResultURI"].links[0]:r._meta["prez:searchResultURI"].links)}),console.log(s.listHeaders),s}form(e=[],t=[],s){console.log("FORM");let r=0,a=s||"";if(a==""){const l=this.firstQuad(null,b,null,null);if(l!==null)a=l.subject.value,l.object.value;else throw new Error("rdf:type predicate not found")}const c=this.store.getQuads(a,v,null,null),i=this.compact(a),o={formHeaders:{},header:{label:c.length>0?c[0].object.value:i,iri:a,link:a},count:r,fields:{},iri:this.compact(a)},n=this.expandAll(e),g=this.expandAll(t),h=this.getSubjectData(a,n,g);return Object.keys(h).filter(l=>l!="_meta").forEach(l=>{l in o.formHeaders||(a[0]!="_"||l!="iri")&&(o.formHeaders[l]=this.getHeader(this.expand(l),h[l]))}),o.count=Object.keys(o.formHeaders).length,o.fields=h,o}getSubjectData(e,t,s){const r={iri:e,_meta:{}},a=this.store.getQuads(e,null,null,null);for(const c in a){const i=a[c],o=this.compact(i.predicate.value),n=this.getMeta(i,t,s);if(i.object instanceof Q)o in r||(r[o]=[]),r[o].push(this.form(t,s,"_:"+i.object.value));else{const g=this.store.getQuads(e,i.predicate.value,null,null);let h,l=[];g.map(f=>{const{label:u,description:p}=this.getAnnotations(f.object.value,t,s);if(f.predicate.value=="https://prez.dev/searchResultURI"){const k=this.firstQuad(f.object.value,this.expand("prez:link"),null,null);k&&l.push(k.object.value)}const R=u!==void 0?u:f.object.value;h!==void 0?(Array.isArray(h)||(h=[h]),h.push(R)):h=R}),n.value=h===void 0?i.predicate.value:h,n.links=l,r._meta[o]=n,r[o]=n.value}}return r}getMeta(e,t,s){const{label:r,description:a}=this.getAnnotations(e.predicate.value,t,s);let c,i;if(e.object.datatype){console.log("DATA TYPE = ",e.object),i=e.object.datatype.value;const n=this.firstQuad(i,v,null,null);c=z(n!==null&&n.object.value?n.object.value.toString():i)}return{iri:e.predicate.value,label:r,description:a,typeIRI:i,type:c}}getHeader(e,t){const s=this.firstQuad(e,v,null,null);return{iri:e,link:v.value,label:z(s!==null&&s.object.value?s.object.value:e),description:""}}getAnnotations(e,t,s){let r,a;return t.map(c=>{if(r===void 0){const i=this.firstQuad(e,c,null,null);i&&(r=i.object.value)}}),s.map(c=>{if(a===void 0){const i=this.firstQuad(e,c,null,null);i&&(a=i.object.value)}}),{label:r,description:a}}compact(e){for(const t in this.prefixes)if(e.startsWith(this.prefixes[t].toString()))return`${t}:${e.substring(this.prefixes[t].toString().length)}`;return e==b.value?"rdf:type":e}}const L=H("rdf",{state:()=>({cache:{},loading:!1,error:"",success:!1,prez:null}),actions:{clearCache(){this.cache={}},async load(d,e){try{this.loading=!0,this.success=!1;const t=d+JSON.stringify(e);t in this.cache?this.prez=this.cache[t]:(this.prez=new U,await this.prez.fetch(d,e),this.cache[t]=this.prez),this.success=!0,this.error=null}catch(t){this.error=t.message,this.success=!1}finally{this.loading=!1}}}});export{L as u};
